---
title: "Airbnb Pricing Analysis in Europe"
author: "Yacine Montacer"
date: "08/05/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

For my end of studies mini-senior project, I found a dataset containing Airbnb rental data for European cities for over 51,000 listings. The dataset includes features such as the total listing price, room type, host status, amenities and location information which can be exploited to analyze these factors' relation to the Airbnb prices. For more information see: <https://www.kaggle.com/datasets/thedevastator/airbnb-price-determinants-in-europe?resource=download>

We have data for several European cities for both weekdays & week-ends. So let's first begin by importing all the different data into one aggregate set:

```{r Importation}
# Create an empty data frame to store the combined data
combined_data <- data.frame()

# Define the list of cities and data types (weekdays and weekends)
cities <- c("amsterdam", "athens", "barcelona", "berlin", "budapest", "lisbon", "london", "paris", "rome", "vienna")
data_types <- c("weekdays", "weekends")

# Loop through each city and data type
for (city in cities) {
  for (data_type in data_types) {
    # Construct the file path for the CSV file
    file_path <- paste("data/", city, "_", data_type, ".csv", sep = "")
    
    # Read the CSV file into a data frame
    city_data <- read.csv(file_path)
    
    # Create variables to identify the city and data type
    city_data$city <- city
    city_data$data_type <- data_type
    
    # Combine the data for the current city and data type with the overall data
    combined_data <- rbind(combined_data, city_data)
  }
}

#display first lines of data 
head(combined_data, 10)
```

Now let's include the libraries we need to move forward: 

```{r Libraries}
library(ggplot2)
library(dplyr)
library(tidyr)
```

Now let's proceed with exploratory data analysis: 

```{r Exploratory Analysis}
# Summary statistics
summary(combined_data)

# Histogram of price
ggplot(combined_data, aes(x = realSum)) +
  geom_histogram(fill = "steelblue", bins = 30) +
  labs(x = "Price", y = "Frequency", title = "Distribution of Prices")

# Boxplot of price by room type
ggplot(combined_data, aes(x = room_type, y = realSum)) +
  geom_boxplot(fill = "steelblue") +
  labs(x = "Room Type", y = "Price", title = "Price Variation by Room Type")

# Scatterplot of price vs. distance to metro
ggplot(combined_data, aes(x = metro_dist, y = realSum)) +
  geom_point(color = "steelblue") +
  labs(x = "Distance to Metro", y = "Price", title = "Price vs. Distance to Metro")
```

let's import additional libraries and proceed with a correlation matrix:

```{r Correlation Matrix}
# Load the necessary libraries
library(dplyr)
library(readr)
library(corrplot)

# Correlation matrix
cor_matrix <- cor(combined_data[, c("realSum", "person_capacity", "cleanliness_rating", "guest_satisfaction_overall", "bedrooms", "dist", "metro_dist", "rest_index", "attr_index", "rest_index_norm", "attr_index_norm", "lng", "lat", "biz")])
cor_matrix

# Visualize the correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust")
```

Seeing the variables that correlate with the price, we can try to create a linear regression model: 

```{r Linear Model}
library(tidyverse)
library(caret)

#model
lm_model <- lm(realSum ~ person_capacity + bedrooms + attr_index_norm + rest_index_norm + guest_satisfaction_overall + dist + metro_dist, data = combined_data)

#summarize LM model
summary(lm_model)
```

Since the linear model is inadequate with a low R squared. I chose to implement a random forest algorithm to see if I can find non-linear relationships between pricing and the exploratory variables

```{r Random Forest}
# Load the required libraries
library(randomForest)
library(caret)

# Define your predictors (independent variables)
predictors <- c(
  "room_shared",
  "room_private",
  "person_capacity",
  "host_is_superhost",
  "multi",
  "biz",
  "cleanliness_rating",
  "guest_satisfaction_overall",
  "bedrooms",
  "dist",
  "metro_dist",
  "attr_index",
  "attr_index_norm",
  "rest_index",
  "rest_index_norm",
  "lng",
  "lat"
)

# Create a data frame with only the selected predictors and the target variable (price)
data_subset <- combined_data[, c(predictors, "realSum")]

# Split the data into a training set and a testing set
set.seed(123)  # for reproducibility
sample_index <- sample(1:nrow(data_subset), 0.7 * nrow(data_subset))
train_data <- data_subset[sample_index, ]
test_data <- data_subset[-sample_index, ]

# Train the Random Forest model
rf_model <- randomForest(realSum ~ ., data = train_data, ntree = 500)

# Make predictions on the test set
predictions <- predict(rf_model, test_data)

# Evaluate the model
rmse <- sqrt(mean((test_data$realSum - predictions)^2))
mae <- mean(abs(test_data$realSum - predictions))

# Print the evaluation metrics
print(paste("Root Mean Squared Error (RMSE):", rmse))
print(paste("Mean Absolute Error (MAE):", mae))
```

```{r R Squared}
# Calculate R-squared
r_squared <- 1 - (sum((test_data$realSum - predictions)^2) / sum((test_data$realSum - mean(test_data$realSum))^2))
print(paste("R-squared (RÂ²):", r_squared))
```

```{r Scatter Plot}
# Create a scatter plot of observed vs. predicted values
plot(test_data$realSum, predictions, xlab = "Observed Price", ylab = "Predicted Price")
abline(0, 1, col = "red")  # Add a diagonal line for reference

```

```{r Residual Plot}
# Create residual plot
residuals <- test_data$realSum - predictions
plot(predictions, residuals, xlab = "Predicted Price", ylab = "Residuals")
abline(h = 0, col = "red")  # Add a horizontal line at zero for reference
```

```{r K-Fold Cross-Validation}
# Perform k-fold cross-validation
library(caret)
set.seed(123)  # for reproducibility
cv <- trainControl(method = "cv", number = 10)  # 10-fold cross-validation
model_cv <- train(realSum ~ ., data = train_data, method = "rf", trControl = cv)
summary(model_cv)  # Print summary of cross-validation results
```

```{r Feature Importance}
# Visualize feature importance
varImpPlot(rf_model)
```

